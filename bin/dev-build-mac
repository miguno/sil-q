#!/usr/bin/env bash
#
# Generate a debug build for macOS native app with Cocoa support.
#
# Requires ASan and UBsan installed.
#

set -euo pipefail

###############################################################################
# Configuration
###############################################################################

# shellcheck disable=SC2155
readonly SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
# shellcheck disable=SC2155
readonly PROJECT_DIR=$(cd "$SCRIPT_DIR/.." && pwd -P)
readonly BUILD_DIR="$PROJECT_DIR/build"
readonly SIL_COCOA_APP="Sil.app"

###############################################################################
# Validate the environment
###############################################################################

# shellcheck disable=SC2155
readonly OS="$(uname)"
if [[ $OS != "Darwin" ]]; then
    echo "ERROR: This script must be run on macOS"
    exit 1
fi

###############################################################################
# Run the build
###############################################################################

echo "========================================================================"
echo "Generating a debug build for macOS native app with Cocoa support"
echo "========================================================================"

cd "$PROJECT_DIR"
cmake -G Ninja -B "$BUILD_DIR" -DCMAKE_BUILD_TYPE=Debug -DBUILD_ENABLE_WERROR=ON -DBUILD_ENABLE_SANITIZERS=ON
cmake --build "$BUILD_DIR"
cp -R "$BUILD_DIR/$SIL_COCOA_APP" "./$SIL_COCOA_APP"

echo "========================================================================"
echo "Run the game via '$SIL_COCOA_APP' in the top-level project folder"

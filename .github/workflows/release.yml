# Creates a draft GitHub Release with versioned release artifacts for all
# platforms (Windows, macOS, Linux) and the source code.
#
# == Creating a new release  ==
#
# Releases (and thus this GitHub Action workflow) are triggered by git tags that
# match the `v*` pattern, like `v1.2.3` or `v1.2.3.4-beta1`. The tag name will
# be used verbatim for naming the release artifacts.
#
# ****************************************************************************
#  IMPORTANT: You must manually ensure that the git release tag (such as
#             `v1.5.1.0`) matches the version information in the source code!
# ****************************************************************************
#
# 1. Create the new release tag. Must have `v` prefix, like `v1.5.0`.
#
#   $ git tag v1.5.1
#
# 2. Push the tag.
#
#   $ git push --tags
#
# This triggers the workflow, which calls the platform workflows (linux.yml,
# mac.yml, windows.yml, src.yml) in release mode via `workflow_call`, passing
# the tag as the `version` input. Each platform workflow then creates a
# versioned archive instead of a snapshot artifact.
#
# The archives are uploaded to a draft release at:
#   https://github.com/<owner>/<repo>/releases
#
# 3. Go to https://github.com/sil-quirk/sil-q/releases to review and edit the
#    (draft) release notes on GitHub, then publish when ready.
#
# Release artifacts are permanent and publicly downloadable.
#
#
# == Testing the release process defined in this file ==
#
# The easiest option to test the release process is to create a "test tag".
# It is also the most realistic test because it runs the actual workflow
# end-to-end.
#
# Because the release is created as a draft, it's not visible to the public. You
# can push a test tag, verify everything works, then delete both the draft
# release and the tag:
#
# 1. Create a "test tag".
#
#   $ git tag v0.0.0-test
#   $ git push --tags
#
# 2. Manually verify that the workflow runs and the draft release appears.
#
# 3. Then clean up:
#
#   # Delete the draft release.
#   # `gh` is the GitHub CLI tool (https://cli.github.com/)
#   $ gh release delete v0.0.0-test -R sil-quirk/sil-q
#
#   # Delete local test tag
#   $ git tag -d v0.0.0-test
#
#   # Delete remote test tag
#   $ git push --delete origin v0.0.0-test
#
# If something didn't work as expected and you must modify any of the GitHub
# Action workflows (including release.yml), then you must push these changes
# first and then try again from scratch with a new test tag.
#

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  linux:
    name: Linux
    uses: ./.github/workflows/linux.yml
    with:
      version: ${{ github.ref_name }}
    secrets: inherit

  macos:
    name: macOS
    uses: ./.github/workflows/mac.yml
    with:
      version: ${{ github.ref_name }}
    secrets: inherit

  windows:
    name: Windows
    uses: ./.github/workflows/windows.yml
    with:
      version: ${{ github.ref_name }}
    secrets: inherit

  source:
    name: Source Code
    uses: ./.github/workflows/src.yml
    with:
      version: ${{ github.ref_name }}
    secrets: inherit

  release:
    name: Create GitHub Release
    needs: [linux, macos, windows, source]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: List release assets
        run: ls -la Sil-Q-*

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: Sil-Q ${{ github.ref_name }}
          draft: true
          generate_release_notes: true
          files: Sil-Q-*
